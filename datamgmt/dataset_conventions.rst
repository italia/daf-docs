DAF Dataset Conventions & Ingestion Pipeline
============================================

The logic behind DAF highly relies on internal conventions when it comes to dataset ingestion, e-gestion and usage. These conventions aims to improve the interoperability between datasets and to make possible the enrichment of the original data with other useful info DAF already knows.
Below, you find a list of conventions used, the ingestion steps, and an example that shows how these conventions are used in practice.

DAF Conventions List
--------------------

* **Data format** (Normalization): all data is transformed into UFT-8 format
* **Data conventions** (Normalization): we make use of the following internal conventions

  * *null value* are saved as ``NULL``. Therefore, all other external conventions used in the raw incoming data (i.e. empty string) are transformed to ``NULL``
  * *date* are transformed using the ISO8601 in ``YYYY-MM-DD hh:mm:ss``
  * *url* are formatted as following ``http[s]://www.yoururl.com``
  * *normalization vocabularies* are used to normalize special cases that will be continuously added to ad-hoc vocabularies, such as accented letters, specific names, etc. The terms in the vocabularies are substituted with the appropriate translation, and this will be done both for all dataset (general normalization vocabularies), or for owner/dataset (source normalization vocabularies and dataset normalization vocabularies).
  * *address* written in a single cell, is interpreted (when possible) and rearranged as follows: `{address type} {address name}, {civic number}, {zip code} {City} ({Provincia/State}), Country`. The system recognize it as address, via semantic tag.

* *new columns from enrichment* are named as following: ``__{enrichment type}[_{column name}]``, where text in  ``{}`` is mandatory, and text in ``[]`` is optional and depends on the type of transformation (some are not connected to an existing column)

  * a  *unique row id* (Enrichment) is added via a new column called ``__ROWID`` to ensure global uniqueness of the id within DAF. It is made as following: ``{dataset name space}_{row hash}`` [TBD]
  * a *generated datetime* (Enrichment) is added with the timestamp of the ingestion in a column called ``__dtcreated``
  * a *updated datetime* (Enrichment) is added with the timestamp of the last update for that row in a column called ``__dtupdate``
  * a *controlled vocabulary standardization* (Standardization) columns is added every time there is a feature/column that is tagged to have a controlled vocabulary associated (the tagging happens in the Catalog Manager, at metadata level). In this case, a procedure is activated to check whether the values contained in the column obey to the vocabulary. This will result in the addition of two columns: ``__std_{col name}`` will have the value of the original column in case they are found in the vocabulary, or the closest value (according to some distance metrics like the Levenshtein distance) in case the value is not exactly found; ``__stdtat_{col name}`` containing the distance between the original value and the closest one found in the vocabulary. Be aware that the final dataset will not contain the ``__std_{col name}`` column, as its value will be put in a column named with the original name ``{col name}``. The ``__std_{col name}`` column is used in intermediate steps of the ingestion process.
  * a *unique identifier / code* (Enrichment) for the standardized columns, in case the controlled vocabulary has a ``code`` associated to the standard label. This column will be called ``__stdcode_{column name}``
  * *address components* (Enrichment): every time there is a column/field tagged as address, this enrichment step will add the following columns inferred from it:

    * ``__address@placetype_{column name}``: it contains the type of address (i.e. via, piazza, viale, ecc.) contained in the address from the column ``{column name}``
    * ``__address@placename_{column name}``: it contains the name of the address (i.e. 'del Corso') contained in the address from the column ``{column name}``
    * ``__address@placecode_{column name}``: it contains the code (unique identifier) of the address from its controlled vocabulary.
    * ``__address@cityname_{column name}``: it contains the name of the city of the address from its controlled vocabulary.
    * ``__address@citycode_{column name}``: it contains the code (unique identifier) of the city from its controlled vocabulary.
    * ``__address@provname_{column name}``: it contains the name of the 'provincia' or state  of the address from its controlled vocabulary.
    * ``__address@provcode_{column name}``: it contains the code (unique identifier) of the 'provincia' or state from its controlled vocabulary.
    * ``__address@countryname_{column name}``: it contains the name of the country of the address from its controlled vocabulary.
    * ``__address@countrycode_{column name}``: it contains the code (unique identifier) of the country from its controlled vocabulary.
    * ``__address@lat_{column name}``: it contains the latitude of the address.
    * ``__address@lon_{column name}``: it contains the longitude of the address.

Ingestion pipeline steps
------------------------

The following steps describe the ingestion pipeline applying the above conventions to the incoming new data.

1. New data are captured from the incoming source and stored into a landing area into DAF HDFS.
2. **Normalization procedures** are applied to the incoming data so to apply DAF conventions. The result will be a dataset with new features/columns added named ``__norm_{col name}``, containing the result of the normalization applied to all features/columns of the original dataset.
3. **Standardization procedures** are applied to the normalized columns of the previous step. The result will be a dataset generated a the previous step, with the addition of the standardized columns (only when the standardization can be applied, so the number of added columns may be less then the total number of columns in the original dataset (step 1.) named ``__std_{col name}``.
4. **Enrichment procedures** are applied to the dataset at step 3, resulting in a new dataset build starting from the one generated in step 3 and adding enrichment columns named as follows ``__{enrichment tuype}[_{col name}]``.
5. **Finalization procedure** takes as input the dataset in step 4 and rearrange its columns as follows: it contains the normalized and standardized columns, named as the original columns in the incoming dataset (step 1); the original raw data columns named ``__raw_{col name}``, the list of enrichment columns from step 4.


Final Dataset Structure
-----------------------

Based on the conventions and ingestion pipelines described above, a final dataset will have the following structure:

* **`ROWID`** column, with a unique identifier for the row.
* **List of dataset columns**: the list of columns of the original raw dataset ingested, at which all the procedures described above have been applied. These columns are named with the original column names provided at the ingestion time.
* **List of original raw columns**: this part reproduce the original data as provided for the ingestion. These columns will be named as follows: `__raw_{col name}`.
* **List of enrichment columns**: those are columns that add additional information to the dataset, extracted at ingestion time. They will be named according to the following convention: `__{enrichment type}[_{col name}]`.

As an example, consider the following dataset to be ingested into DAF.

**Step 1**: Ingest raw incoming data into DAF, after creation of dataset instance in the catalog manager.

+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+----------------------------------------------+-----------------+
| id | company_name | industry_type | address                                   | city   | state  | num_employees | website | description                                  | year_foundation |
+====+==============+===============+===========================================+========+========+===============+=========+==============================================+-----------------+
| 1  | Fiat         | Automobili    | via Gabriele Chiabrera, 20, 10126, Torino | torino | Italai | 1000          | fiat.it | Fiat e' stata fondata nella citta' di torino | ""              |
+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+----------------------------------------------+-----------------+

Among other things, let's suppose that the following metadata has been associated to the dataset:

* `industry_type` has been associated with the ATECO contolled vocabulary
* `address` has been linked to the semantic tag associated to address, and to data type 'address'
* `city` has been linked to the semantic tag associated to the city and connected controlled vocabulary
* `state` has been linked to the semantic tag associated to the state and connected controlled vocabulary
* `website` has been associated to the data type `url`


**Step 2**: Apply normalization procedures

+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+---------------------------------------------+-----------------+-----------+---------------------+----------------------+--------------------------------------------+-------------+--------------+------------------+--------------------+--------------------------------------------+------------------------+
| id | company_name | industry_type | address                                   | city   | state  | num_employees | website | description                                 | year_foundation | __norm_id | __norm_company_name | __norm_industry_type | __norm_address                             | __norm_city | __norm_state | __norm_employees | __norm_website     | __norm_description                         | __norm_year_foundation |
+====+==============+===============+===========================================+========+========+===============+=========+=============================================+=================+===========+=====================+======================+============================================+=============+==============+==================+====================+============================================+========================+
| 1  | Fiat         | Automobili    | via Gabriele Chiabrera, 20, 10126, Torino | torino | Italai | 1000          | fiat.it | Fiat e'stata fondata nella citta' di torino | ""              | 1         | Fiat                | Automobili           | via Gabriele Chiambrera, 20, 10126, Torino | Torino      | Italia       | 1000             | http://www.fiat.it | Fiat è stata fondata nella città di Torino | NULL                   |
+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+---------------------------------------------+-----------------+-----------+---------------------+----------------------+--------------------------------------------+-------------+--------------+------------------+--------------------+--------------------------------------------+------------------------+


**Step 3**: Apply standardization procedures

+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+---------------------------------------------+-----------------+-----------+---------------------+----------------------+--------------------------------------------+-------------+--------------+------------------+--------------------+--------------------------------------------+------------------------+------------------------------+-------------------------+------------+----------------+-------------+-----------------+
| id | company_name | industry_type | address                                   | city   | state  | num_employees | website | description                                 | year_foundation | __norm_id | __norm_company_name | __norm_industry_type | __norm_address                             | __norm_city | __norm_state | __norm_employees | __norm_website     | __norm_description                         | __norm_year_foundation | __std_industry_type          | __stdstat_industry_type | __std_city | __stdstat_city | __std_state | __stdstat_state |
+====+==============+===============+===========================================+========+========+===============+=========+=============================================+=================+===========+=====================+======================+============================================+=============+==============+==================+====================+============================================+========================+==============================+=========================+============+================+=============+=================+
| 1  | Fiat         | Automobili    | via Gabriele Chiabrera, 20, 10126, Torino | torino | Italai | 1000          | fiat.it | Fiat e'stata fondata nella citta' di torino | ""              | 1         | Fiat                | Automobili           | via Gabriele Chiambrera, 20, 10126, Torino | Torino      | Italai       | 1000             | http://www.fiat.it | Fiat è stata fondata nella città di Torino | NULL                   | Fabbricazione di Autoveicoli | 45                      | Torino     | 0              | Italia      | 1               |
+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+---------------------------------------------+-----------------+-----------+---------------------+----------------------+--------------------------------------------+-------------+--------------+------------------+--------------------+--------------------------------------------+------------------------+------------------------------+-------------------------+------------+----------------+-------------+-----------------+


**Step 4**: Apply enrichment procedures

+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+---------------------------------------------+-----------------+-----------+---------------------+----------------------+--------------------------------------------+-------------+--------------+------------------+--------------------+--------------------------------------------+------------------------+------------------------------+-------------------------+------------+----------------+-------------+-----------------+-----------------------------------+-------------+-------------+-------------------------+-----------------------------+-----------------------------+---------------------------------+----------------------------+---------------------------+----------------------------+----------------------------+-----------------------+-----------------------+
| id | company_name | industry_type | address                                   | city   | state  | num_employees | website | description                                 | year_foundation | __norm_id | __norm_company_name | __norm_industry_type | __norm_address                             | __norm_city | __norm_state | __norm_employees | __norm_website     | __norm_description                         | __norm_year_foundation | __std_industry_type          | __stdstat_industry_type | __std_city | __stdstat_city | __std_state | __stdstat_state | __ROWID                           | __dtcreated | __dtupdated | __stdcode_industry_type | __address@placetype_address | __address@placename_address | __address@placenamecode_address | __address@placenum_address | __address@zipcode_address | __address@cityname_address | __address@citycode_address | __address@lat_address | __address@lon_address |
+====+==============+===============+===========================================+========+========+===============+=========+=============================================+=================+===========+=====================+======================+============================================+=============+==============+==================+====================+============================================+========================+==============================+=========================+============+================+=============+=================+===================================+=============+=============+=========================+=============================+=============================+=================================+============================+===========================+============================+============================+=======================+=======================+
| 1  | Fiat         | Automobili    | via Gabriele Chiabrera, 20, 10126, Torino | torino | Italai | 1000          | fiat.it | Fiat e'stata fondata nella citta' di torino | ""              | 1         | Fiat                | Automobili           | via Gabriele Chiambrera, 20, 10126, Torino | Torino      | Italai       | 1000             | http://www.fiat.it | Fiat è stata fondata nella città di Torino | NULL                   | Fabbricazione di Autoveicoli | 45                      | Torinoi    | 0              | Italia      | 1               | 574832sdfd958fds742398_1514467919 | 1514467919  | 1514467919  | 29.10.0                 | via                         | via Gabriele Chiambrera     | 12321213                        | 20                         | 10126                     | {'ita': 'Torino'}          | 23423234                   | 45.0458               | 7.6788                |
+----+--------------+---------------+-------------------------------------------+--------+--------+---------------+---------+---------------------------------------------+-----------------+-----------+---------------------+----------------------+--------------------------------------------+-------------+--------------+------------------+--------------------+--------------------------------------------+------------------------+------------------------------+-------------------------+------------+----------------+-------------+-----------------+-----------------------------------+-------------+-------------+-------------------------+-----------------------------+-----------------------------+---------------------------------+----------------------------+---------------------------+----------------------------+----------------------------+-----------------------+-----------------------+


**Step 5**: Finalization

| RAW DATA                                                                                                                                                                                                                               | FINALIZED DATA                                                                                                                                                                                                  | ENRICHMENT COLUMNS                                                                                                                                                                                                                                                                                                                                                                                                    |
+----------+--------------------+---------------------+-------------------------------------------+------------+-------------+---------------------+---------------+---------------------------------------------+-----------------------+----+--------------+------------------------------+--------------------------------------------+--------+--------+-----------+--------------------+--------------------------------------------+-----------------+-------------------------+----------------+-----------------+-----------------------------------+-------------+-------------+-------------------------+-----------------------------+-----------------------------+---------------------------------+----------------------------+---------------------------+----------------------------+----------------------------+-----------------------+-----------------------+
| __raw_id | __raw_company_name | __raw_industry_type | __raw_address                             | raw_city   | __raw_state | __raw_num_employees | __raw_website | __raw_description                           | __raw_year_foundation | id | company_name | industry_type                | address                                    | city   | state  | employees | website            | description                                | year_foundation | __stdstat_industry_type | __stdstat_city | __stdstat_state | __ROWID                           | __dtcreated | __dtupdated | __stdcode_industry_type | __address@placetype_address | __address@placename_address | __address@placenamecode_address | __address@placenum_address | __address@zipcode_address | __address@cityname_address | __address@citycode_address | __address@lat_address | __address@lon_address |
+==========+====================+=====================+===========================================+============+=============+=====================+===============+=============================================+=======================+====+==============+==============================+============================================+========+========+===========+====================+============================================+=================+=========================+================+=================+===================================+=============+=============+=========================+=============================+=============================+=================================+============================+===========================+============================+============================+=======================+=======================+
| 1        | Fiat               | Automobili          | via Gabriele Chiabrera, 20, 10126, Torino | torino     | Italai      | 1000                | fiat.it       | Fiat e'stata fondata nella citta' di torino | ""                    | 1  | Fiat         | Fabbricazione di Autoveicoli | via Gabriele Chiambrera, 20, 10126, Torino | Torino | Italia | 1000      | http://www.fiat.it | Fiat è stata fondata nella città di Torino | NULL            | 45                      | 0              | 1               | 574832sdfd958fds742398_1514467919 | 1514467919  | 1514467919  | 29.10.0                 | via                         | via Gabriele Chiambrera     | 12321213                        | 20                         | 10126                     | {'ita': 'Torino'}          | 23423234                   | 45.0458               | 7.6788                |
+----------+--------------------+---------------------+-------------------------------------------+------------+-------------+---------------------+---------------+---------------------------------------------+-----------------------+----+--------------+------------------------------+--------------------------------------------+--------+--------+-----------+--------------------+--------------------------------------------+-----------------+-------------------------+----------------+-----------------+-----------------------------------+-------------+-------------+-------------------------+-----------------------------+-----------------------------+---------------------------------+----------------------------+---------------------------+----------------------------+----------------------------+-----------------------+-----------------------+
